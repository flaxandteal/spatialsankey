!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3"),require("d3-scale")):"function"==typeof define&&define.amd?define(["exports","d3","d3-scale"],r):r(n.d3=n.d3||{},n.d3$1,n.d3)}(this,function(n,r,e){"use strict";function t(){var n,r={},e={},t=[],o=[],i={},u={};return r.lmap=function(e){return arguments.length?(n=e,r):n},r.nodes=function(n){return arguments.length?(e=n,e.features&&(e=e.features),e.forEach(function(n){n.geometry.coordinates.reverse()}),r):e},r.flows=function(n){return arguments.length?(o=n,r):o},r.ranges=function(){return e=e.map(function(n){var r=t.filter(function(r){return r.target==n.id}),e=t.filter(function(r){return r.source==n.id});return n.properties.aggregate_inflows=r.reduce(function(n,r){return n+r.flow},0),n.properties.aggregate_outflows=e.reduce(function(n,r){return n+r.flow},0),n}),u.min=d3.min(t,function(n){return n.flow}),u.max=d3.max(t,function(n){return n.flow}),i.min=d3.min(e,function(n){var r=n.properties.aggregate_outflows;return 0==r?null:r}),i.max=d3.max(e,function(n){return n.properties.aggregate_outflows}),{links:u,nodes:i}},r.links=function(n){if(!arguments.length)return t;t=n,t=t.map(function(n){var r=e.filter(function(r){return r.id==n.source})[0],t=e.filter(function(r){return r.id==n.target})[0];if(!r||!t)return null;n.source_coords=r.geometry.coordinates,n.target_coords=t.geometry.coordinates;var i=o.filter(function(r){return r.id==n.id})[0];return i&&(n.flow=i.flow),n.flow=parseFloat(n.flow),n});var i=t.length;return t=t.filter(function(n){return null!=n}),i!=t.length&&console.log("Dropped "+(i-t.length)+" links that could not be matched to a node."),r.ranges(),r},r.link=function(r){var e=.4,t=.1,o={min:1,max:8},i=!1,a=!1;r&&(r.xshift&&(e=r.xshift),r.yshift&&(t=r.yshift),r.minwidth&&(o.min=r.minwidth),r.maxwidth&&(o.max=r.maxwidth),r.use_arcs&&(i=r.use_arcs),r.flip&&(a=r.flip));var f=function(r){var o=n.latLngToLayerPoint(r.source_coords),u=n.latLngToLayerPoint(r.target_coords),f=o.x-u.x,l=o.y-u.y;if(i)if(l<0||a)var c=[e*f,t*l,t*f,e*l];else var c=[t*f,e*l,e*f,t*l];else if(l<0||a)var c=[e*f,t*l,e*f,t*l];else var c=[t*f,e*l,t*f,e*l];return"M"+o.x+","+o.y+"C"+(o.x-c[0])+","+(o.y-c[1])+" "+(u.x+c[2])+","+(u.y+c[3])+" "+u.x+","+u.y},l=function(n){if(0==n.flow&&0!=u.min)return 0;var r=n.flow-u.min,e=u.max-u.min;return(o.max-o.min)*(r/e)+o.min};return f.width=function(n){return arguments.length?l=n:l},f},r.node=function(r){var e={min:10,max:20},t=["yellow","red"];r&&(r.minradius&&(e.min=r.minradius),r.maxradius&&(e.max=r.maxradius),r.mincolor&&(t[0]=r.mincolor),r.maxcolor&&(t[1]=r.maxcolor));var o=d3.scaleLinear().domain([0,1]).range(t),u={};return u.cx=function(r){var e=n.latLngToLayerPoint(r.geometry.coordinates).x;return e||null},u.cy=function(r){var e=n.latLngToLayerPoint(r.geometry.coordinates).y;return e||null},u.r=function(n){if(0==n.properties.aggregate_outflows)return 0;var r=n.properties.aggregate_outflows-i.min,t=i.max-i.min;return(e.max-e.min)*(r/t)+e.min},u.color=function(n){return arguments.length?(o=n,u):o},u.fill=function(n){var r=n.properties.aggregate_outflows-i.min,e=i.max-i.min;return o(r/e)},u},r}n.spatialsankey=t,Object.defineProperty(n,"__esModule",{value:!0})});