!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("d3")):"function"==typeof define&&define.amd?define(["exports","d3"],r):r(n.d3=n.d3||{},n.d3)}(this,function(n,r){"use strict";function e(){var n,e={},t={},o=[],i=[],a={},u={};return e.lmap=function(r){return arguments.length?(n=r,e):n},e.nodes=function(n){return arguments.length?(t=n,t.features&&(t=t.features),t.forEach(function(n){n.geometry.coordinates.reverse()}),e):t},e.flows=function(n){return arguments.length?(i=n,e):i},e.ranges=function(){return t=t.map(function(n){var r=o.filter(function(r){return r.target==n.id}),e=o.filter(function(r){return r.source==n.id});return n.properties.aggregate_inflows=r.reduce(function(n,r){return n+r.flow},0),n.properties.aggregate_outflows=e.reduce(function(n,r){return n+r.flow},0),n}),u.min=r.min(o,function(n){return n.flow}),u.max=r.max(o,function(n){return n.flow}),a.min=r.min(t,function(n){var r=n.properties.aggregate_outflows;return 0==r?null:r}),a.max=r.max(t,function(n){return n.properties.aggregate_outflows}),{links:u,nodes:a}},e.links=function(n){if(!arguments.length)return o;o=n,o=o.map(function(n){var r=t.filter(function(r){return r.id==n.source})[0],e=t.filter(function(r){return r.id==n.target})[0];if(!r||!e)return null;n.source_coords=r.geometry.coordinates,n.target_coords=e.geometry.coordinates;var o=i.filter(function(r){return r.id==n.id})[0];return o&&(n.flow=o.flow),n.flow=parseFloat(n.flow),n});var r=o.length;return o=o.filter(function(n){return null!=n}),r!=o.length&&console.log("Dropped "+(r-o.length)+" links that could not be matched to a node."),e.ranges(),e},e.link=function(r){var e=.4,t=.1,o={min:1,max:8},i=!1,a=!1;r&&(r.xshift&&(e=r.xshift),r.yshift&&(t=r.yshift),r.minwidth&&(o.min=r.minwidth),r.maxwidth&&(o.max=r.maxwidth),r.use_arcs&&(i=r.use_arcs),r.flip&&(a=r.flip));var f=function(r){var o=n.latLngToLayerPoint(r.source_coords),u=n.latLngToLayerPoint(r.target_coords),f=o.x-u.x,l=o.y-u.y;if(i)if(l<0||a)var c=[e*f,t*l,t*f,e*l];else var c=[t*f,e*l,e*f,t*l];else if(l<0||a)var c=[e*f,t*l,e*f,t*l];else var c=[t*f,e*l,t*f,e*l];return"M"+o.x+","+o.y+"C"+(o.x-c[0])+","+(o.y-c[1])+" "+(u.x+c[2])+","+(u.y+c[3])+" "+u.x+","+u.y},l=function(n){if(0==n.flow&&0!=u.min)return 0;var r=n.flow-u.min,e=u.max-u.min;return(o.max-o.min)*(r/e)+o.min};return f.width=function(n){return arguments.length?l=n:l},f},e.node=function(e){var t={min:10,max:20};node_color_range=["yellow","red"],e&&(e.minradius&&(t.min=e.minradius),e.maxradius&&(t.max=e.maxradius),e.mincolor&&(node_color_range[0]=e.mincolor),e.maxcolor&&(node_color_range[1]=e.maxcolor));var o=r.scale.linear().domain([0,1]).range(node_color_range),i={};return i.cx=function(r){return cx=n.latLngToLayerPoint(r.geometry.coordinates).x,cx||null},i.cy=function(r){return cy=n.latLngToLayerPoint(r.geometry.coordinates).y,cy||null},i.r=function(n){if(0==n.properties.aggregate_outflows)return 0;var r=n.properties.aggregate_outflows-a.min,e=a.max-a.min;return(t.max-t.min)*(r/e)+t.min},i.color=function(n){return arguments.length?(o=n,i):o},i.fill=function(n){var r=n.properties.aggregate_outflows-a.min,e=a.max-a.min;return o(r/e)},i},e}n.spatialsankey=e,Object.defineProperty(n,"__esModule",{value:!0})});